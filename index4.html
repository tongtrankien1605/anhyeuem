<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falling 3D Text with Layers and Panning</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            perspective: 500px;
            background-color: #000000;
        }
        #scene {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.15s ease-out;
        }
        .falling-text, .heart, .rose {
            position: absolute;
            white-space: nowrap;
            pointer-events: none;
            transform-style: preserve-3d;
            will-change: transform; /* Tối ưu hóa hiệu suất */
        }
        .falling-text {
            color: #ff69b4;
            font-size: 3vw;
            opacity: 0.9;
            text-shadow: 0 0 5px rgba(255, 105, 180, 0.8),
                         0 0 10px rgba(255, 105, 180, 0.6);
            animation: fall 5s linear forwards, fadeInOut 2s infinite alternate;
        }
        .heart {
            color: #ff1493;
            font-size: 3vw;
            opacity: 0.8;
            text-shadow: 0 0 3px #ff1493, 0 0 5px #ff1493;
            animation: fall 6s linear forwards, float 4s infinite ease-in-out;
        }
        .rose {
            color: #ff4040;
            font-size: 2.5vw;
            opacity: 0.8;
            transform: rotate(45deg);
            text-shadow: 0 0 3px #ff4040, 0 0 5px #ff4040;
            animation: fall 7s linear forwards, float 4s infinite ease-in-out;
        }
        @keyframes fall {
            from { transform: translateY(-50px); }
            to { transform: translateY(100vh); }
        }
        @keyframes fadeInOut {
            from { opacity: 0.9; }
            to { opacity: 0.6; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @media (max-width: 768px) {
            .falling-text { font-size: 4vw; }
            .heart { font-size: 4vw; }
            .rose { font-size: 3.5vw; }
        }
    </style>
</head>
<body>
    <div id="scene"></div>
    <audio id="backgroundMusic" loop>
        <source src="https://raw.githubusercontent.com/tongtrankien1605/anhyeuem/main/music/ngay-hanh-phuc.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <script>
        // Xử lý âm thanh
        const audio = document.getElementById("backgroundMusic");
        let hasPlayed = false;
        document.addEventListener("touchstart", () => {
            if (!hasPlayed) {
                audio.play().then(() => {
                    hasPlayed = true;
                    console.log("Nhạc đã phát khi chạm!");
                }).catch(e => console.error("Lỗi phát nhạc:", e));
            }
        });
        document.addEventListener("click", () => {
            if (!hasPlayed) {
                audio.play().then(() => {
                    hasPlayed = true;
                    console.log("Nhạc đã phát khi click!");
                }).catch(e => console.error("Lỗi phát nhạc:", e));
            }
        });

        // Danh sách văn bản
        const texts = [
            "♥ Tống Trần Kiên ♥",
            "Thương em",
            "Mãi mãi bên nhau bạn nhớ",
            "Em là bà nội của tui",
            "LOVE U SO MUCH",
            "Tao là bố chúng mày",
            "Cùng nhau đi khắp thế gian",
            "Tình yêu là mãi mãi",
            "Em là tất cả của anh",
        ];

        const scene = document.getElementById("scene");
        let rotateX = 0, rotateY = 0;
        let targetRotateX = 0, targetRotateY = 0;
        const maxRotate = 30;
        let isDragging = false;
        const maxElements = 50; // Giới hạn tối đa phần tử
        let elementCount = 0; // Theo dõi số lượng phần tử

        // Xử lý tương tác chuột
        document.addEventListener("mousedown", () => { isDragging = true; });
        document.addEventListener("mousemove", (e) => {
            if (isDragging) {
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                targetRotateY = ((e.clientX - centerX) / centerX) * maxRotate;
                targetRotateX = ((e.clientY - centerY) / centerY) * maxRotate;
            }
        });
        document.addEventListener("mouseup", () => {
            isDragging = false;
            targetRotateX = 0;
            targetRotateY = 0;
        });

        // Xử lý cảm ứng
        let touchStartX = 0, touchStartY = 0;
        document.addEventListener("touchstart", (e) => {
            isDragging = true;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });
        document.addEventListener("touchmove", (e) => {
            e.preventDefault();
            if (isDragging) {
                const touchMoveX = e.touches[0].clientX;
                const touchMoveY = e.touches[0].clientY;
                const deltaX = (touchMoveX - touchStartX) / window.innerWidth * maxRotate * 2;
                const deltaY = (touchMoveY - touchStartY) / window.innerHeight * maxRotate * 2;
                targetRotateY = deltaX;
                targetRotateX = -deltaY;
            }
        });
        document.addEventListener("touchend", () => {
            isDragging = false;
            touchStartX = 0;
            touchStartY = 0;
            targetRotateX = 0;
            targetRotateY = 0;
        });

        // Cập nhật xoay cảnh
        function updateRotation() {
            rotateX += (targetRotateX - rotateX) * 0.1;
            rotateY += (targetRotateY - rotateY) * 0.1;
            scene.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            requestAnimationFrame(updateRotation);
        }
        updateRotation();

        // Hàm tạo phần tử chung
        function createElement(type, initial = false) {
            if (elementCount >= maxElements) return; // Không tạo nếu vượt giới hạn

            const element = document.createElement("div");
            element.className = type;
            if (type === "falling-text") {
                element.innerText = texts[Math.floor(Math.random() * texts.length)];
                element.style.color = `hsl(${Math.random() * 360}, 80%, 70%)`;
                element.style.fontSize = `${Math.random() * 2 + 2}vw`;
            } else {
                element.innerText = "♥";
                if (type === "rose") {
                    element.style.transform = `rotate(${Math.random() * 360}deg)`;
                }
            }

            const startX = Math.random() * window.innerWidth;
            const zLayer = Math.random() * 100 - 50; // Giảm phạm vi Z để tối ưu
            element.style.left = startX + "px";
            element.style.top = initial ? (Math.random() * window.innerHeight) + "px" : "-50px";
            element.style.transform += `translateZ(${zLayer}px)`;

            scene.appendChild(element);
            elementCount++;

            // Xóa phần tử sau khi animation kết thúc
            element.addEventListener("animationend", () => {
                element.remove();
                elementCount--;
            });
        }

        // Khởi tạo ban đầu
        for (let i = 0; i < 10; i++) createElement("falling-text", true);
        for (let i = 0; i < 5; i++) createElement("heart", true);
        for (let i = 0; i < 3; i++) createElement("rose", true);

        // Tạo phần tử mới với tần suất thấp hơn
        setInterval(() => createElement("falling-text"), 600);
        setInterval(() => createElement("heart"), 800);
        setInterval(() => createElement("rose"), 1000);
    </script>
</body>
</html>